<!DOCTYPE HTML>
<html>
<head>
  <title>Jarvis</title>
  <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
</head>
<body>
<h2>Send:</h2>
<form id="emit" method="POST" action='#'>
  <input type="text" name="emit_data" id="emit_data" placeholder="Message">
  <input type="submit" value="Send">
  <input type="button" value="Click to Speak" onclick="startRecording()">
</form>
<h2>Receive:</h2>
<div id="log"></div>
  <script type="text/javascript">
    var socket;

    var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
    var recognition = new SpeechRecognition();

    function startRecording () {
      recognition.start();
    }

    $(document).ready(function () {
      var namespace = '/master';
      socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

      var emit = function (type, data) {
        data = data || {};
        data.type = type;
        socket.emit('event', data);
      };

      socket.on('connect', function () {
        emit('user:connect');
      });

      socket.on('response', function (message) {
        $div = $('<div>', {text: 'Jarvis:  ' + message.text});
        $div.css('white-space', 'pre-line');
        $('#log').append('<br>').append($div);

        if (message.isAudio) {
          var audioUrl = 'http://confluxapp.s3-website-us-west-1.amazonaws.com/jarvis/speech.ogg?cb=' + new Date().getTime();

          if (message.data && message.data.soundbite) {
            audioUrl = message.data.soundbite;
          }

          var audio = new Audio(audioUrl);
          audio.load();
          audio.play();
        }
      });

      $('#emit').submit(function () {
        var $input = $('#emit_data');
        emit('message:new', { text: $input.val() });
        $input.val('').focus();
        return false;
      });

      recognition.onresult = function (e) {
        if (e.results.length > 0) {
          emit('message:new', { text: event.results[0][0].transcript });
        }
      };

    });

  </script>
</body>
</html>
